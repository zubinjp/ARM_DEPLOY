trigger:
  branches:
    include:
      - main  # Trigger pipeline on changes to the 'main' branch

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: Group1  # Reference the variable group containing predefined variables
  - name: subnetName
    value: 'mySubnet'
  - name: vnetName
    value: 'myVnet'
  - name: system.debug
    value: 'true'  # Enable debug logs

jobs:
  - job: DeployARMTemplate
    displayName: 'Deploy ARM Template to Azure'
    steps:
      # Step 1: Print Debug Information
      - script: |
          echo "DEBUG: resourceGroupName: $(resourceGroupName)"
          echo "DEBUG: subscriptionId: $(subscriptionId)"
          echo "DEBUG: vmUsername: $(vmUsername)"
          echo "DEBUG: vmssName: $(vmssName)"
          echo "DEBUG: subnetName: $(subnetName)"
          echo "DEBUG: vnetName: $(vnetName)"
        displayName: 'Print Debug Information'

      # Step 2: Validate ARM Template
      - task: AzureCLI@2
        inputs:
          azureSubscription: 'VMSS-connection'  # Azure DevOps Service connection
          scriptType: 'bash'
          scriptLocation: 'inlineScript'
          inlineScript: |
            echo "##vso[task.debug]Enabling debug logs..."
            echo "Setting subscription context..."
            az account set --subscription "$(subscriptionId)"

            # Validate ARM Template
            echo "Validating ARM Template..."
            validation_output=$(az deployment group validate \
              --resource-group "$(resourceGroupName)" \
              --template-file arm-temp.json \
              --parameters \
              adminUsername="$(vmUsername)" \
              adminPassword="$(vmPassword)" \
              roleAssignmentPrincipalId="$(roleAssignmentPrincipalId)" \
              roleDefinitionId="$(roleDefinitionId)" \
              subscriptionId="$(subscriptionId)" \
              subnetName="$(subnetName)" \
              vnetName="$(vnetName)" \
              vmssName="$(vmssName)" \
              resourceGroupName="$(resourceGroupName)" \
              --verbose 2>&1)  # Use --verbose for detailed output

            # Log the full validation output
            echo "Validation Output: $validation_output"

            # Capture the exit code
            validation_exit_code=$?

            # If the exit code is not 0, it indicates an error occurred
            if [ $validation_exit_code -ne 0 ]; then
              echo "##[error] ARM Template validation failed with exit code $validation_exit_code."
              echo "##[debug] Validation Output: $validation_output"
              exit 1
            fi

            echo "ARM Template validation successful. Proceeding with deployment."

            # Deploy ARM Template
            echo "Deploying ARM Template..."
            deploy_output=$(az deployment group create \
              --resource-group "$(resourceGroupName)" \
              --template-file arm-temp.json \
              --parameters \
              adminUsername="$(vmUsername)" \
              adminPassword="$(vmPassword)" \
              roleAssignmentPrincipalId="$(roleAssignmentPrincipalId)" \
              roleDefinitionId="$(roleDefinitionId)" \
              subscriptionId="$(subscriptionId)" \
              subnetName="$(subnetName)" \
              vnetName="$(vnetName)" \
              vmssName="$(vmssName)" \
              resourceGroupName="$(resourceGroupName)" \
              --verbose 2>&1)

            # Log the deployment output
            echo "Deployment Output: $deploy_output"

            # Capture the exit code
            deploy_exit_code=$?

            # If the exit code is not 0, it indicates an error occurred
            if [ $deploy_exit_code -ne 0 ]; then
              echo "##[error] ARM Template deployment failed with exit code $deploy_exit_code."
              echo "##[debug] Deployment Output: $deploy_output"
              exit 1
            fi

            echo "ARM Template deployed successfully!"
        displayName: 'Deploy ARM Template'
